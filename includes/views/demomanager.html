<div id="demos">
    <div id="loader" style="display:none">
        <img src="images/loader.gif" />
    </div>
    <div v-if="errorMsg != ''" class="alert alert-danger">
        <div v-html="lng(errorMsg)"></div>
    </div>
    <div v-if="successMsg != ''" class="alert alert-success">
        <div v-html="lng(successMsg)"></div>
    </div>
    
    <h2>{{ lng('DEMOS') }}</h2>
    <div id="browser" class="browser" style="display:none">
        <div class="row">
            <!-- gyakran javítandó -->
            <div class="col-12">
                <h4>{{ lng('SEARCH') }}</h4>
                <form class="filterForm" id="filterForm" method="post" action="index.php">
                    <input type="hidden" name="task" value="demo.items" />
                    <input type="hidden" name="page" value="1" />
                    <label>{{ lng('NAME') }}</label>
                    <input type="text" name="filter_name" id="filter_name"/>
                    <button type="button" class="btn btn-primary" v-on:click="searchClick()" v-bind:title="lng('SEARCH')">
                        <em class="fas fa-search"></em>
                    </button>
                    <button type="button" class="btn btn-secondary" v-on:click="delSearchClick()" v-bind:title="lng('CLEARSERCH')">
                        <em class="fas fa-times"></em>
                    </button>
                </form>
            </div>
        </div>
        <div class="row">
            <table class="col-12 table table-bordered table-striped" v-if="items.length > 0">
                <tr>
                    
				<th  class="id" id="th_id" v-on:click="thClick('id')">
					{{ lng("ID") }}
					<em class="fas fa-sort-down"></em>
					<em class="fas fa-sort-up"></em>
				</th>
				
				<th  class="name" id="th_name" v-on:click="thClick('name')">
					{{ lng("NAME") }}
					<em class="fas fa-sort-down"></em>
					<em class="fas fa-sort-up"></em>
				</th>
				
				<th  class="description" id="th_description" v-on:click="thClick('description')">
					{{ lng("DESCRIPTION") }}
					<em class="fas fa-sort-down"></em>
					<em class="fas fa-sort-up"></em>
				</th>
				
                </tr>
                <tr v-for="item in items">
                    <td class="id"><var v-html="encodeTd(item.id)"></var></td><td class="name"><var v-html="encodeTd(item.name)"></var></td><td class="description"><var v-html="encodeTd(item.description)"></var></td>
					<td>
					<button type="button" class="btn btn-primary"  v-on:click="this.record = item; showClick()">
						<em class="fas fa-eye" v-bind:title="lng('SHOW')"></em>
					</button>
					<button type="button" class="btn btn-primary"  v-if="logedAdmin" 
						v-on:click="this.record = item; editClick()">
						<em class="fas fa-edit" v-bind:title="lng('EDIT')"></em>
					</button>
					<button type="button" class="btn btn-danger" v-if="logedAdmin" 
						v-on:click="this.record = item; delClick()">
						<em class="fas fa-eraser" v-bind:title="lng('DELETE')"></em>
					</button>
					</td> 
		
                </tr>
            </table>
        </div>
        <div class="alert alert-info col-12" v-if="items.length == 0">{{ lng('NOT_ITEMS') }}</div>
        <div v-if="items.length > 0">
            <div id="paginator"></div>
        </div>
        <div class="row" v-if="logedAdmin">
            <div class="col-12">
                <button type="button" class="btn btn-primary" v-on:click="newClick()">
                    <em class="fas fa-plus"></em><span>{{ lng('ADD') }}</span>
                </button>
            </div>
        </div>
    </div><!-- browser -->

    <div id="show" style="display:none">
        <div id="demoShow" class="show">
            <div class="formButtons" v-if="logedAdmin">
                <div class="col-12">
                    <button type="button" 
                       v-on:click="editClick()"
                       class="btn btn-primary">
                        <em class="fas fa-edit"></em>&nbsp;{{ lng('EDIT') }}
                    </button>
                    <button type="button" 
                       v-on:click="delClick()"
                       class="btn btn-danger">
                        <em class="fas fa-eraser"></em>&nbsp;{{ lng('DELETE') }}
                    </button>
                </div>
            </div>
            
					<div class="row id">
						<div class="col-12">
							<label>{{ lng("ID") }}:</label>
							<var  v-html="record.id2" 
								class="id"
								v-if="ckeditorFields.indexOf('id') >= 0">
							</var>
							<var  v-html="record.id" 
								class="id"
								v-if="ckeditorFields.indexOf('id') < 0">
							</var>
						</div>
					</div>
					
					<div class="row name">
						<div class="col-12">
							<label>{{ lng("NAME") }}:</label>
							<var  v-html="record.name2" 
								class="name"
								v-if="ckeditorFields.indexOf('name') >= 0">
							</var>
							<var  v-html="record.name" 
								class="name"
								v-if="ckeditorFields.indexOf('name') < 0">
							</var>
						</div>
					</div>
					
					<div class="description">
						<div class="col-12">
							<label>{{ lng("DESCRIPTION") }}:</label>
							<var  v-html="record.description2" 
								class="description"
								v-if="ckeditorFields.indexOf('description') >= 0">
							</var>
							<var  v-html="record.description" 
								class="description"
								v-if="ckeditorFields.indexOf('description') < 0">
							</var>
						</div>
					</div>

            <div class="row formButtons">
                <div class="col-12">
                    <button type="button" v-if="logedAdmin"
                       v-on:click="editClick()"
                       class="btn btn-primary">
                        <em class="fas fa-edit"></em>&nbsp;{{ lng('EDIT') }}
                    </button>
                    <button type="button" v-if="logedAdmin"
                       v-on:click="delClick()"
                       class="btn btn-danger">
                        <em class="fas fa-eraser"></em>&nbsp;{{ lng('DELETE') }}
                    </button>
                    <button type="button" class="btn btn-secondary" v-on:click="listClick()">
                        <em class="fas fa-reply"></em>&nbsp;{{ lng('BACK') }}
                    </a>
                </div>
            </div>
        </div>    
    </div><!-- show -->

    <div id="form" style="display:none" v-on:keyup.enter="saveClick()">
        <h2>{{ lng('DEMO') }}</h2>
        <h3 v-if="record.id == 0">{{ lng('ADD') }}</h3>
        <h3 v-if="record.id > 0">{{ lng('EDIT') }}</h3>
        <form id="demoForm" class="form" 
            enctype="multipart/form-data">
            <div class="row formButtons" v-if="!logedAdmin">
                <div class="col-12">
                    <button type="button" class="btn btn-secondary" v-on:lcick="listClick()">
                        <em class="fas fa-reply"></em>&nbsp;{{ lng('BACK') }}
                    </button>&nbsp;
                </div>
            </div>
            <div class="row formButtons" v-if="logedAdmin">
                <div class="col-12">
                    <button type="button" class="btn btn-success" v-on:click="saveClick()">
                        <em class="fas fa-check"></em>&nbsp;{{ lng('SAVE') }}
                    </button>&nbsp;
                    <button type="button" class="btn btn-secondary" v-on:click="listClick()">
                        <em class="fas fa-reply"></em>&nbsp;{{ lng('CANCEL') }}
                    </button>&nbsp;
                    <button type="button" 
                       v-on:click="delClick()"
                       v-if="record.id > 0"
                       class="btn btn-danger">
                        <em class="fas fa-eraser"></em>&nbsp;{{ lng('DELETE') }}
                    </button>
                </div>
            </div>
            
					<div class="row">
						<div class="col-12">
							<label>{{ lng("ID") }}</label>:
							<input type="number" name="id" v-model="record.id" disabled="disabled" />
							<input type="hidden" name="id" v-model="record.id" />
						</div>
					</div>
					
					<div class="row">
						<div class="col-12">
							<label>{{ lng("NAME") }}</label>:
							<input type="text" name="name" id="name" v-model="record.name"  required="required" class="form-control name" />
						</div>
					</div>
					
					<div class="row">
						<div class="col-12">
							<label>{{ lng("DESCRIPTION") }}</label>:
							<textarea cols="60" rows="5" name="description" id="description" v-html="record.description" class="form-control description"></textarea>
						</div>
					</div>
					
                    <div class="row">
                        <div class="col-12">
                            <label>{{ lng('FILE') }}</label>
                            <input type="file" id="file" name="file" class="form-control" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <table id="progressTable" style="width:100%; display:none">
                                <tr style="border-style:solid; border-width:1px; border-color:blue">
                                    <td id="progressImg">&nbsp;</td>
                                    <td style="background-color:white"></td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="text-align:center"><var id="progressTxt"></var></td>
                                </tr>
                            </table>
                        </div>
                    </div>

            <div class="row formButtons" v-if="logedAdmin">
                <div class="col-12">
                    <button type="button" class="btn btn-success" v-on:click="saveClick()">
                        <em class="fas fa-check"></em>&nbsp;{{ lng('SAVE') }}
                    </button>&nbsp;
                    <button type="button" class="btn btn-secondary" v-on:click="listClick()">
                        <em class="fas fa-reply"></em>&nbsp;{{ lng('CANCEL') }}
                    </button>&nbsp;
                    <button type="button" 
                       v-on:click="delClick()"
                       v-if="record.id > 0"
                       class="btn btn-danger">
                        <em class="fas fa-eraser"></em>&nbsp;{{ lng('DELETE') }}
                    </button>
                </div>
            </div>
            <div class="row formButtons" v-if="!logedAdmin">
                <div class="col-12">
                    <button type="button" class="btn btn-secondary" v-on:lcick="listClick()">
                        <em class="fas fa-reply"></em>&nbsp;{{ lng('BACK') }}
                    </button>&nbsp;
                </div>
            </div>
        </form>    
    </div><!-- form -->



</div>

<script>
    methods = {
		afterMount() {
            if (window.afterMountFinished) {
                // run oly once!
                return;
            }
            this.items = [];
            this.total = 0;
            this.selfUrl = '';
			if (this.filter != undefined) {
				// filter strintg (name|value....)  to filterForm
				if ((this.filter != '') & (this.filter != 'all')) {
					var filter = this.filter.split('|');
					var i = 0;
					var fn = '';
					while (i < filter.length) {
						fn = filter[i];
						document.getElementById('filter_'+fn).value = filter[i+1];
						i = i + 2;
					}
				}
			}
            if ((this.show != '') & (this.show != undefined)) {
                $('#loader').show();
                window.axios.get(HREF('damo.api_getItem',{id:this.show, sid: this.sid}))
                .then(function(response) {
                    $('#loader').hide();
                    app.record = response.data;
                    app.showClick(this.show);
                });
            } else if ((this.edit != '') & (this.edit != undefined)) {
                $('#loader').show();
                window.axios.get(HREF('damo.api_getItem',{id:this.edit, sid: this.sid}))
                .then(function(response) {
                    $('#loader').hide();
                    app.record = response.data;
                    app.editClick(this.show);
                });
            } else {
                this.listClick();                
            }
            for (key in this.ckeditorFields) {
				window.ckeditorUploadServer = HREF('demo.api_upload',{});
				console.log('window.ckeditorUploadServer='+window.ckeditorUploadServer);
				
                ckeditorInit('#'+this.ckeditorFields[key]);
            }
            window.afterMountFinished = true;
		},
        showPaginator(page) {
            include showPaginator
        },  
        searchClick() {
            this.filter = 'name|'+document.getElementById('filter_name').value;
            this.page = 1;
            this.listClick();
        }, 
        delSearchClick() {
			// document.getElementById('filter_name').value = '';
			this.filter='all';
            this.listClick();
		},
        adjustShareLinks() {
            $('#shareFb').attr('href', 
                'https://www.facebook.com/sharer/sharer.php?u='+this.selfUrl);
            $('#shareTw').attr('href',
                'https://twitter.com/intent/tweet?text='+this.selfUrl);
            $('#shareLi').attr('href',
                'https://www.linkedin.com/shareArticle?mini=true&url='+this.selfUrl);
            $('#shareMail').attr('href',
                'https://mail.google.com/mail/?view=cm&body='+this.selfUrl);
            $('#shareIn').attr('href',
                'https://www.instagram.com/?url='+this.selfUrl);
        },
        listClick() {
            if (this.page == undefined) { this.page = 1; }
            if (this.limit == undefined) { this.limit = window.innerHeight / 45; }
            if (this.limit < 2) { this.limit = window.innerHeight / 45; }
            if (this.order == undefined) { this.order = 'id'; }
            if (this.orderDir == undefined) { this.orderDir = 'ASC'; }
            if (this.filter == undefined) { this.filter = ''; }
            if (this.page < 1) this.page = 1;
            var pageCount = Math.round((this.total / this.limit) + 0.5);
            if (this.page > pageCount) this.page = pageCount;
            this.selfUrl = HREF('demo.manager', {page:this.page});
            this.adjustShareLinks();
            $('#loader').show();
            window.axios.get(HREF('demo.api_getItems',
                {page:this.page, limit:this.limit, order: this.order, orderdir: this.orderDir, filter:this.filter, sid: this.sid}))
            .then(function(response) {
                $('#loader').hide();
                app.items = response.data;
                //console.log(app.items);
                $('#loader').show();
                window.axios.get(HREF('demo.api_getTotal',
                    {filter:app.filter, sid: this.sid}))
                .then(function(response) {
                    $('#loader').hide();
                    app.total = response.data;
                    app.showPaginator(app.page);
                    // adjust ordericons
                    if (app.total > 0) {
                        for (fieldName in app.items[0]) {
                            if ($('#th_'+fieldName)) {
                                if (app.order == fieldName) {
                                    if (app.orderDir == 'ASC') {
                                        $('#th_'+fieldName+' .fa-sort-down').show();
                                        $('#th_'+fieldName+' .fa-sort-up').hide();
                                    } else {
                                        $('#th_'+fieldName+' .fa-sort-up').show();
                                        $('#th_'+fieldName+' .fa-sort-down').hide();
                                    }
                                } else { 
                                    $('#th_'+fieldName+' .fa-sort-down').hide();
                                    $('#th_'+fieldName+' .fa-sort-up').hide();
                                }    
                            }
                        }
                    }
                    $('#show').hide();
                    $('#form').hide();
                    $('#browser').show();
                    window.scrollTo(0,0);
                });
            });
        },
        paginatorClick(p) {
            this.page = p;
            this.listClick();
        },    
        showClick() {
            this.selfUrl = HREF('demo.manager', {show:this.record.id});
            this.adjustShareLinks();
            $('#loader').show();
            window.axios.get(HREF('demo.api_getItem',{id:this.record.id}))
            .then(function(response) {
                $('#loader').hide();
                app.record = response.data;
                $('#show').show();
                $('#form').hide();
                $('#browser').hide();
            });    
        },
        formClick() {
            for (key in this.ckeditorFields) {
                if (window.editors['#'+this.ckeditorFields[key]]) {
                    window.editors['#'+this.ckeditorFields[key]].setData(this.record[this.ckeditorFields[key]]);
                }
            }
            $('#show').hide();
            $('#form').show();
            $('#browser').hide();
            // rendszerint javítandó
            $('#name').focus();
        },    
        editClick() {
            this.selfUrl = HREF('demo.manager', {edit:this.record.id});
            this.adjustShareLinks();
            this.formClick();
        },
        newClick() {
            this.selfUrl = HREF('demo.manager', {browser:1, filter:'all'});
            this.adjustShareLinks();
            $('#loader').show();
            window.axios.get(HREF('demo.api_emptyRecord',{sid: this.sid}))
            .then(function(response) {
                $('#loader').hide();
                app.record = response.data;
                app.formClick();
            });    
        },
        fileUpload(record) {
            var progressTable = $('progressTable');
			  var progressImg = $('progressImg');
			  var progressTxt = $('progressTxt');
			  progressImg.style='width:0%; background-color:blue';
			  progressTxt.innerHTML = '0%';
			  progressTable.show();
			  // file upload
			  var data = new FormData();
			  data.append('foo', 'bar');
			  data.append('file', document.getElementById('file').files[0]);
			  data.append('uploadDir','./images/uploads');
			  data.append('record', JSON.stringify(record));
			  data.append('sid',this.sid);
			  var config = {
				onUploadProgress: function(progressEvent) {
                  var progressTable = $('progressTable');
        		  var progressImg = $('progressImg');
			      var progressTxt = $('progressTxt');
				  var percentCompleted = Math.round( (progressEvent.loaded * 100) / progressEvent.total );
				  progressImg.style='width:'+percentCompleted+'%; background-color:blue';
				  progressTxt.innerHTML = percentCompleted+'%';
				}
			  };
			  axios.post(HREF('demo.api_upload.php',{}), data, config) 
			  .then(function (res) {
				  // fileUrl beírása a rekordba
				  if (res.data.url != undefined) {
//+ Gyakran átírandó !!!!
					  app.record.description += ' uploaded file:'+res.data.url;
//-					  
					  // this.sid = this.sid;
					  axios.post(HREF('demo.api_save',{}),
							   app.record, 
							   { headers: {'Content-Type': 'multipart/form-data'}})
					  .then(function(response) {
                        $('#loader').hide();
							app.listClick();
					  }) 
				  } else {
					$('#loader').hide();
					// popupMsg(res.data.error,'popupError');
                    $('#loader').hide();
					app.listClick();
				  }
				})
		},        
        saveClick() {
            for (key in this.ckeditorFields) {
                if (window.editors['#'+this.ckeditorFields[key]]) {
                   this.record[this.ckeditorFields[key]] = window.editors['#'+this.ckeditorFields[key]].getData();
                }
            }
            var param = this.record;
            param.sid = this.sid;
            $('#loader').show();
            axios.post(HREF('demo.api_save',{}),
                       param, 
                       { headers: {'Content-Type': 'multipart/form-data'}})
            .then(function(response) {
                $('#loader').hide();
                var result = response.data;
                if ((result.error != '') & (result.error != undefined)) {
                    popupMsg(window.lng(result.error),'popupError');
                } else {
                    app.record.id = result.id;
                    //+ ha nincs file upload
                    // app.listClick();
                    //-
                    //+ ha van file upload
                    app.fileUpload(app.record);
                    //-
                }
            });    
        },
        delClick() {
            popupConfirm(lng('SUREDELETE'), 
            function() {
                $('#popup').hide();
                $('#loader').show();
                window.axios.get(HREF('demo.api_delete',{id:app.record.id, sid:app.sid}))
                .then(function(response) {
                    $('#loader').hide();
                    var result = response.data;
                    if ((result.error != '') & (result.error != undefined)) {
                        popupMsg(window.lng(result.error),'popupError');
                    } else {
                        app.listClick();
                     }
                });    
            })
        },
        showDescription(description) {
            var result = description;
            if (result != undefined) {
                // if not hrml then replace \n --> <br />
                if (result.indexOf('<') == -1) {
                    result = result.replace(/\n/g, '<br />');
                }
            }
            return result;
        },
        thClass(fieldName) {
            var result = '';
            if (this.order == fieldName) {
                if (this.orderDir == 'ASC') {
                    result = 'text-success';
                } else {
                    result = 'text-danger';
                }    
            }
            return result;
        },
        thClick(fieldName) {
            if (this.order == fieldName) {
                if (this.orderDir == 'ASC') {
                    this.orderDir = 'DESC';
                } else {
                    this.orderDir = 'ASC';      
                }
            } else {
                this.orderDir = 'ASC';
            } 
            this.order = fieldName;
            this.listClick();
        },
        encodeTd(rawStr) {
            // valamiért TD -ben az első/utolsó ' és " gondot okoz :(
			return '&nbsp;'+rawStr+'&nbsp;';
		}

    };
</script>
