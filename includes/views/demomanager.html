<div id="demos">
    <div v-if="errorMsg != ''" class="alert alert-danger">
        <div v-html="lng(errorMsg)"></div>
    </div>
    <div v-if="successMsg != ''" class="alert alert-success">
        <div v-html="lng(successMsg)"></div>
    </div>
    
    <h2>{{ lng('DEMOS') }}</h2>
    <div id="browser" style="display:none">
        <div class="row">
            <div class="col-12">
                <h4>{{ lng('SEARCH') }}</h4>
                <form class="filterForm" id="filterForm" method="post" action="index.php">
                    <input type="hidden" name="task" value="demo.items" />
                    <input type="hidden" name="page" value="1" />
                    <label>{{ lng('NAME') }}</label>
                    <input type="text" name="filter_name" id="filter_name"/>
                    <button type="button" class="btn btn-primary" v-on:click="searchClick()" title="lng('SEARCH')">
                        <em class="fas fa-search"></em>
                    </button>
                    <button type="button" class="btn btn-secondary" v-on:click="delSearchClick()">
                        <em class="fas fa-times"></em>
                    </button>
                </form>
            </div>
        </div>
        <div class="row">
            <table class="col-12 table table-bordered table-striped" style="width:auto" v-if="items.length > 0">
                <tr><th style="width:30px">ID</th>
                    <th style="width:60px">{{ lng('NAME') }}</th>
                    <th></th>
                </tr>
                <tr v-for="item in items">
                    <td>{{ item.id }}</td>
                    <td> 
                            {{ item.name }}
                    </td>    
                    <td>
                        <button type="button" class="btn btn-primary"  v-on:click="this.record = item; showClick()">
                            <em class="fas fa-eye" v-bind:title="lng('SHOW')"></em>
                        </button>
                        <button type="button" class="btn btn-primary"  v-if="logedAdmin" 
                            v-on:click="this.record = item; editClick()">
                            <em class="fas fa-edit" v-bind:title="lng('EDIT')"></em>
                        </button>
                        <button type="button" class="btn btn-danger" v-if="logedAdmin" 
                            v-on:click="this.record = item; delClick()">
                            <em class="fas fa-eraser" v-bind:title="lng('DELETE')"></em>
                        </button>
                    </td> 
                </tr>
            </table>
        </div>
        <div class="alert alert-info col-12" v-if="items.length == 0">{{ lng('NOT_ITEMS') }}</div>
        <div v-if="items.length > 0">
            <div id="paginator"></div>
        </div>
        <div class="row" v-if="logedAdmin">
            <div class="col-12">
                <button type="button" class="btn btn-primary" v-on:click="newClick()">
                    <em class="fas fa-plus"></em><span>{{ lng('ADD') }}</span>
                </button>
            </div>
        </div>
    </div><!-- browser -->

    <div id="show" style="display:none">
        <div id="demoShow" class="form">
            <div class="row formButtons" v-if="logedAdmin">
                <div class="col-12">
                    <button type="button" 
                       v-on:click="editClick()"
                       class="btn btn-primary">
                        <em class="fas fa-edit"></em>&nbsp;{{ lng('EDIT') }}
                    </button>
                    <button type="button" 
                       v-on:click="delClick()"
                       class="btn btn-danger">
                        <em class="fas fa-eraser"></em>&nbsp;{{ lng('DELETE') }}
                    </button>
                </div>
            </div>
            <!-- 
                FIGYELEM! a ckeditorral kezelt mezőknél itt egy "2" karaktert kell a mezőnév végére illeszteni 
                pl: {{ record.description2 }}
            -->
            
                        <div class="row">
                            <div class="col-12">
                                <label>{{ lng("ID") }}</label>:
                                <var v-html="record.id"></var>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <label>{{ lng("NAME") }}</label>:
                                <var v-html="record.name"></var>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <label class="align-top">{{ lng("DESCRIPTION") }}:</label>
                                <div style="display:inline-block; width:65%">
                                    <code><pre>{{ record.description }}</pre></code>
                                </div>
                            </div>
                        </div>
                        
            <div class="row formButtons">
                <div class="col-12">
                    <button type="button" v-if="logedAdmin"
                       v-on:click="editClick()"
                       class="btn btn-primary">
                        <em class="fas fa-edit"></em>&nbsp;{{ lng('EDIT') }}
                    </button>
                    <button type="button" v-if="logedAdmin"
                       v-on:click="delClick()"
                       class="btn btn-danger">
                        <em class="fas fa-eraser"></em>&nbsp;{{ lng('DELETE') }}
                    </button>
                    <button type="button" class="btn btn-secondary" v-on:click="listClick()">
                        <em class="fas fa-reply"></em>&nbsp;{{ lng('BACK') }}
                    </a>
                </div>
            </div>
        </div>    
    </div><!-- show -->

    <div id="form" style="display:none">
        <h2>{{ lng('DEMO') }}</h2>
        <h3 v-if="record.id == 0">{{ lng('ADD') }}</h3>
        <h3 v-if="record.id > 0">{{ lng('EDIT') }}</h3>
        <form id="demoForm" class="form" 
            enctype="multipart/form-data"  style="display:blocl">
            
                        <div class="row">
                            <div class="col-12">
                                <label>{{ lng("ID") }}</label>:
                                <input type="number" name="id" v-model="record.id" disabled="disabled" />
                                <input type="hidden" name="id" v-model="record.id" />
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <label>{{ lng("NAME") }}</label>:
                                <input type="text" name="name" id="name" v-model="record.name"  required="required" />
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <label>{{ lng("DESCRIPTION") }}</label>:
                                <textarea cols="60" rows="5" name="description" id="description" v-model="record.description"></textarea>
                            </div>
                        </div>
                        
            <div class="row formButtons" v-if="logedAdmin">
                <div class="col-12">
                    <button type="button" class="btn btn-success" v-on:click="saveClick()">
                        <em class="fas fa-check"></em>&nbsp;{{ lng('SAVE') }}
                    </button>&nbsp;
                    <button type="button" class="btn btn-secondary" v-on:click="listClick()">
                        <em class="fas fa-reply"></em>&nbsp;{{ lng('CANCEL') }}
                    </button>&nbsp;
                    <button type="button" 
                       v-on:click="delClick()"
                       v-if="record.id > 0"
                       class="btn btn-danger">
                        <em class="fas fa-eraser"></em>&nbsp;{{ lng('DELETE') }}
                    </button>
                </div>
            </div>
            <div class="row formButtons" v-if="!logedAdmin">
                <div class="col-12">
                    <button type="button" class="btn btn-secondary" v-on:lcick="listClick()">
                        <em class="fas fa-reply"></em>&nbsp;{{ lng('BACK') }}
                    </button>&nbsp;
                </div>
            </div>
        </form>    
    </div><!-- form -->



</div>

<script>
    methods = {
		afterMount() {
            if (window.afterMountFinished) {
                // run oly once!
                return;
            }
            this.record = {};
            this.items = [];
            this.total = 0;
            this.selfUrl = '';
			if (this.filter != undefined) {
				// filter strintg (name|value....)  to filterForm
				if ((this.filter != '') & (this.filter != 'all')) {
					var filter = this.filter.split('|');
					var i = 0;
					var fn = '';
					while (i < filter.length) {
						fn = filter[i];
						document.getElementById('filter_'+fn).value = filter[i+1];
						i = i + 2;
					}
				}
			}
            if ((this.show != '') & (this.show != undefined)) {
                window.axios.get(HREF('damo.api_getItem',{id:this.show, sid: this.sid}))
                .then(function(response) {
                    app.record = response.data;
                    app.showClick(this.show);
                });
            } else if ((this.edit != '') & (this.edit != undefined)) {
                window.axios.get(HREF('damo.api_getItem',{id:this.edit, sid: this.sid}))
                .then(function(response) {
                    app.record = response.data;
                    app.editClick(this.show);
                });
            } else {
                this.listClick();                
            }
            window.afterMountFinished = true;
		},
        showPaginator(page) {
            var pageCount = (this.total / this.limit) + 0.5;
            page = parseInt(page); // azért, hogy biztosan számolni lehessen vele
            var pointCounter = 0; // megjelenitett '.' számláló
            var k = (window.innerWidth * 0.6) / 36; // össesen ennyi .paginatorItem fér ki
            k = (k - 5) / 2; // az aktuáis elemtől jobbra/balra ennyi fér ki.
            if (page == 1) {
                k = k + 2; // mivel nincs az első két elem; lehet több is
            } 
            if (page == pageCount) {
                k = k + 2; // mivel nincs az utolsó két elem; lehet több is
            } 
            var s=lng('TOTAL')+':'+this.total+'<br /><ul class="paginator">';
            if (page > 1) {	
                s += '<li><span class="paginatorItem2"><var href="#" onclick="app.page = 1; app.listClick()" title="első">&lt;&lt;</var></span></li>';
                s += '<li><span class="paginatorItem2"><var href="#" onclick="app.page = (page - 1); app.listClick()" title="elöző">&lt;</var></span></li>';
            }
            var p = 1;
            while (p <= pageCount) {
                if (p == page) {
                    s += '<li><input id="goPage" type="text" value="'+p+'" size="2"'+
                    ' onchange="app.page = $(\'#goPage\').val(); app.listClick();" /></li>';
                    pointCounter = 0;
                } else {
                    if (((p >= (page - k)) & (p < page)) | 
                        ((p <= (page + k)) & (p > page))) {	
                        s += '<li><span class="paginatorItem2"><var href="#" onclick="app.page = p; app.listClick()" title="'+p+'">'+p+'</var></span></li>';
                    } else {
                        if (pointCounter == 0) {
                            s += '<li class="kimarad">.</li>';
                            pointCounter = pointCounter + 1;
                        }
                    }	
                }	
                p = p + 1;
            }
            $('#paginator').html(s);
        },  
        searchClick() {
            this.filter = 'name|'+document.getElementById('filter_name').value;
            this.page = 1;
            this.listClick();
        }, 
        delSearchClick() {
			// document.getElementById('filter_name').value = '';
			this.filter='all';
            this.listClick();
		},
        adjustShareLinks() {
            $('#shareFb').attr('href', 
                'https://www.facebook.com/sharer/sharer.php?u='+this.selfUrl);
            $('#shareTw').attr('href',
                'https://twitter.com/intent/tweet?text='+this.selfUrl);
            $('#shareLi').attr('href',
                'https://www.linkedin.com/shareArticle?mini=true&url='+this.selfUrl);
            $('#shareMail').attr('href',
                'https://mail.google.com/mail/?view=cm&body='+this.selfUrl);
            $('#shareIn').attr('href',
                'https://www.instagram.com/?url='+this.selfUrl);
        },
        listClick() {
            if (this.page == undefined) { this.page = 1; }
            if (this.limit == undefined) { this.limit = 20; }
            if (this.order == undefined) { this.order = 'id'; }
            if (this.filter == undefined) { this.filter = ''; }
            this.selfUrl = HREF('demo_vue.manager', {page:this.page});
            this.adjustShareLinks();
            window.axios.get(HREF('demo_vue.api_getItems',
                {page:this.page, limit:this.limit, order: this.order, filter:this.filter, sid: this.sid}))
            .then(function(response) {
                app.items = response.data;
                window.axios.get(HREF('demo_vue.api_getTotal',
                    {filter:app.filter, sid: this.sid}))
                .then(function(response) {
                    app.total = response.data;
                    app.showPaginator(this.page);
                    $('#show').hide();
                    $('#form').hide();
                    $('#browser').show();
                });
            });
        },
        paginatorClick(p) {
            this.page = p;
            this.listClick();
        },    
        showClick() {
            this.selfUrl = HREF('demo_vue.manager', {show:this.record.id});
            this.adjustShareLinks();
            $('#show').show();
            $('#form').hide();
            $('#browser').hide();
        },
        formClick() {
            $('#show').hide();
            $('#form').show();
            $('#browser').hide();
        },    
        editClick() {
            this.selfUrl = HREF('demo_vue.manager', {edit:this.record.id});
            this.adjustShareLinks();
            this.formClick();
        },
        newClick() {
            this.selfUrl = HREF('demo_vue.manager', {browser:1, filter:'all'});
            this.adjustShareLinks();
            window.axios.get(HREF('demo_vue.api_emptyRecord',{sid: this.sid}))
            .then(function(response) {
                app.record = response.data;
                app.formClick();
            });    
        },
        saveClick() {
            //this.record.description = encodeURI(this.record.description);
            var param = this.record;
            param.sid = this.sid;
            axios.post(HREF('demo_vue.api_save',{}),
                       param, 
                       { headers: {'Content-Type': 'multipart/form-data'}})
            .then(function(response) {
                var result = response.data;
                if ((result.error != '') & (result.error != undefined)) {
                    popupMsg(window.lng(result.error),'popupError');
                } else {
                    app.record.id = result.id;
                    app.listClick();
                }
            });    
        },
        delClick() {
            popupConfirm(lng('SUREDELETE'), 
            function() {
                $('#popup').hide();
                window.axios.get(HREF('demo_vue.api_delete',{id:app.record.id, sid:app.sid}))
                .then(function(response) {
                    var result = response.data;
                    if ((result.error != '') & (result.error != undefined)) {
                        popupMsg(window.lng(result.error),'popupError');
                    } else {
                        app.listClick();
                     }
                });    
            })
        },
    };
</script>
